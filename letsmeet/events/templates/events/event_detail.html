{% extends 'base.html' %}
{% load rules event_tags static bootstrap_tags %}

{% block page_title %}
Event: {{ event.name }} ({{ event.begin }})
{% endblock %}

{% block content %}
{% if user.is_authenticated %}
{% has_perm 'event.can_edit' user event as can_edit %}
{% has_perm 'event.can_rsvp' user event as can_rsvp %}
{% has_perm 'event.can_create_comment' user event as can_create_comment %}
{% get_community_event_rsvp user event as rsvp %}
{% endif %}

<div class="block-area text-right">
    {% if can_edit %}
    <a class="btn" href="{{ event.get_update_url }}"><i class="fa fa-pencil-square-o"></i> Edit</a>
    {% endif %}
    <a class="btn" href="{{ event.community.get_absolute_url }}"><i class="fa fa-users"></i> Back to community</a>
</div>

<div class="block-area">
    <table class="table">
        <tr>
            <th>Begin</th>
            <td>{{ event.begin }}</td>
        </tr>
        <tr>
            <th>End</th>
            <td>{{ event.end }}</td>
        </tr>
    </table>
</div>

<div class="block-area">
    <h3>Will you join?</h3>
    {% if can_rsvp %}
    {% if not rsvp %}
    <div class="row">
        <form method="POST" action="{{ event.get_rsvp_yes_url }}" class="inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-lg btn-success"><i class="fa fa-check"></i> Yes</button>
        </form>
        <form method="POST" action="{{ event.get_rsvp_no_url }}" class="inline m-l-20">
            {% csrf_token %}
            <button type="submit" class="btn btn-lg btn-danger"><i class="fa fa-times"></i> No</button>
        </form>
    </div>
    {% else %}
    <p>
    You answered <span class="label label-{% if rsvp.coming %}success{% else %}danger{% endif %}">{% if rsvp.coming %}Yes{% else %}No{% endif %}</span>.
    </p>
    <p>
        <form method="POST" action="{{ event.get_rsvp_reset_url }}">
            {% csrf_token %}
            <button type="submit" class="btn btn-link">Change answer</button>
        </form>
    </p>
    {% endif %}
    {% else %}
    <div class="alert alert-info" role="alert">
        You must be logged in and subscribed to the community to RSVP.
    </div>
    {% endif %}
</div>

<div class="block-area">
    <h3>RSVPs</h3>

    <p>
        <span class="label label-success">{{ event.rsvp_yes.count }}</span> coming<br>
        <span class="label label-danger">{{ event.rsvp_no.count }}</span> not coming
    </p>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>User</th>
                <th>Coming?</th>
                <th>RSVPed on</th>
            </tr>
        </thead>
        <tbody>
            {% for rsvp in event.rsvps.all %}
            <tr>
                <td>{{ rsvp.user.username }}</td>
                <td>
                    <span class="label label-{% if rsvp.coming %}success"><i class="fa fa-check"></i>{% else %}danger"><i class="fa fa-times"></i>{% endif %}</span>
                    {{ rsvp.coming|yesno }}
                </td>
                <td>
                    {{ rsvp.modified }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan=3><em>Nobody RSVPed until now</em></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="block-area">
    <h3>Comments</h3>
    <div class="tile">
        <div class="listview narrow">
            {% if can_create_comment %}
            <div class="media">
                <a href="" onclick="$('#write-comment').slideDown(); return false"><i class="fa fa-plus"></i> Write Comment</a>
            </div>
            <div id="write-comment" class="tile" style="display:none">
                <div class="row">
                    <div class="col-md-6">
                        <form method="POST" action="{{ event.get_comment_create_url }}">
                            {% csrf_token %}
                            {{ comment_form|as_bootstrap }}
                            <button class="btn pull-right" type="submit"><i class="fa fa-plus"></i> Send</button>
                            <a href="" class="btn" onclick="$('#write-comment').slideUp(); return false;"><i class="fa fa-times"></i> Cancel</a>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% for comment in event.comments.all %}
            <div class="media p-10">
                <div class="pull-left">
                    <img width="40" src="{% static 'img/letsmeet_icon.png' %}" alt="">
                </div>
                <div class="media-body">
                    <small class="text-muted">{{ comment.created|timesince }} ago by {{ comment.user.username }}</small><br>
                    <p>{{ comment.text|linebreaksbr }}</p>
                </div>
            </div>
            {% empty %}
            <div class="media p-l-5">
                <em>No comments yet.</em>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock content %}
